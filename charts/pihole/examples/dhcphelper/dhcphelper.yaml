# DHCP Helper Deployment (Rootless)
#
# This container receives DHCP broadcasts on the host network and forwards
# them as unicast to the Pi-hole pod. This allows Pi-hole to handle DHCP
# without requiring hostNetwork on the Pi-hole pod itself.
#
# ROOTLESS OPERATION:
# This deployment runs as unprivileged user (nobody/65534) using alternate
# ports 1067/1068 instead of privileged ports 67/68.
#
# PREREQUISITE: Traffic Control (tc) rules must be configured on each node
# to redirect DHCP traffic. See README.md for details.
#
# NOTE: Adjust the service name below if your Helm release is not named "pihole"

apiVersion: apps/v1
kind: Deployment
metadata:
  name: dhcphelper
  labels:
    app: dhcphelper
spec:
  replicas: 1
  selector:
    matchLabels:
      app: dhcphelper
  template:
    metadata:
      labels:
        app: dhcphelper
    spec:
      # Required: Must use host network to receive Layer 2 DHCP broadcasts
      hostNetwork: true
      # Use cluster DNS despite hostNetwork
      dnsPolicy: ClusterFirstWithHostNet

      # Required: Schedule on same node as Pi-hole
      # Without this, DHCP relay fails due to cross-node networking issues
      # (UDP frames may not reach Pi-hole or source IP gets rewritten by NAT)
      # NOTE: Adjust "pihole" value below if your release name differs
      affinity:
        podAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
            - labelSelector:
                matchExpressions:
                  - key: app.kubernetes.io/name
                    operator: In
                    values:
                      - pihole
              topologyKey: "kubernetes.io/hostname"

      # Optional: Pin to a specific node
      # Uncomment and adjust for your cluster
      # nodeSelector:
      #   kubernetes.io/hostname: your-node-name

      containers:
        - name: dhcphelper
          image: ghcr.io/slyrc/dhcp-helper:1.3.0

          # Rootless security context
          securityContext:
            runAsUser: 65534       # nobody
            runAsGroup: 65534
            allowPrivilegeEscalation: false
            capabilities:
              drop: ["ALL"]

          # dhcp-helper arguments for rootless operation with alternate ports
          # -p 1067  : Listen on port 1067 instead of 67 (requires tc redirect)
          # -P 1068  : Use port 1068 for responses instead of 68
          # -s       : Pi-hole DHCP service (DNS name for cluster resolution)
          args:
            - "-p"
            - "1067"
            - "-P"
            - "1068"
            - "-s"
            - "pihole-dhcp.default.svc.cluster.local"  # <-- Adjust namespace if needed

          # Health check
          livenessProbe:
            exec:
              command:
                - /bin/sh
                - -c
                - "pgrep dhcp-helper"
            initialDelaySeconds: 10
            periodSeconds: 30

          resources:
            limits:
              cpu: 50m
              memory: 32Mi
            requests:
              cpu: 10m
              memory: 16Mi

      # Minimal restart policy
      restartPolicy: Always
